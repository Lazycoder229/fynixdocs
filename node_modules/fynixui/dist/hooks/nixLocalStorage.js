import { nixState } from "./nixState";
function safeJSONParse(value, fallback) {
    if (value === null || value === undefined) {
        return fallback;
    }
    try {
        if (typeof value !== "string") {
            console.warn("[nixLocalStorage] Non-string value provided to JSON.parse");
            return fallback;
        }
        const suspiciousPatterns = [
            /__proto__/,
            /constructor/,
            /prototype/,
            /function\s*\(/,
            /=>\s*{/,
            /javascript:/,
            /<script/i,
        ];
        for (const pattern of suspiciousPatterns) {
            if (pattern.test(value)) {
                console.warn("[nixLocalStorage] Potentially malicious content detected, using fallback");
                return fallback;
            }
        }
        const parsed = JSON.parse(value);
        if (parsed && typeof parsed === "object") {
            if (parsed.constructor !== Object && parsed.constructor !== Array) {
                console.warn("[nixLocalStorage] Unsafe object constructor detected");
                return fallback;
            }
        }
        return parsed;
    }
    catch (error) {
        console.warn("[nixLocalStorage] JSON parsing failed:", error);
        return fallback;
    }
}
function safeJSONStringify(value, maxSize = 1024 * 1024) {
    try {
        const stringified = JSON.stringify(value);
        if (stringified.length > maxSize) {
            console.warn("[nixLocalStorage] Value too large to store:", stringified.length, "characters");
            return null;
        }
        return stringified;
    }
    catch (error) {
        console.warn("[nixLocalStorage] JSON stringification failed:", error);
        return null;
    }
}
export function nixLocalStorage(key, initial) {
    if (!key || typeof key !== "string") {
        throw new Error("[nixLocalStorage] Key must be a non-empty string");
    }
    if (key.length > 100) {
        throw new Error("[nixLocalStorage] Key too long (max 100 characters)");
    }
    let initialValue;
    let isStorageValid = true;
    try {
        if (typeof localStorage === "undefined") {
            console.warn("[nixLocalStorage] localStorage not available, using in-memory fallback");
            isStorageValid = false;
            initialValue = initial;
        }
        else {
            const stored = localStorage.getItem(key);
            initialValue = safeJSONParse(stored, initial);
        }
    }
    catch (err) {
        console.error(`[nixLocalStorage] Error reading key "${key}":`, err);
        initialValue = initial;
        isStorageValid = false;
    }
    const state = nixState(initialValue);
    const set = (v) => {
        if (!isStorageValid) {
            state.value = v;
            return false;
        }
        try {
            const stringified = safeJSONStringify(v);
            if (stringified === null) {
                console.error(`[nixLocalStorage] Failed to stringify value for key "${key}"`);
                return false;
            }
            localStorage.setItem(key, stringified);
            state.value = v;
            return true;
        }
        catch (err) {
            console.error(`[nixLocalStorage] Error setting key "${key}":`, err);
            state.value = v;
            return false;
        }
    };
    const clear = () => {
        try {
            if (isStorageValid) {
                localStorage.removeItem(key);
            }
            state.value = initial;
        }
        catch (err) {
            console.error(`[nixLocalStorage] Error clearing key "${key}":`, err);
        }
    };
    const getSize = () => {
        try {
            if (!isStorageValid)
                return 0;
            const stored = localStorage.getItem(key);
            return stored ? stored.length : 0;
        }
        catch {
            return 0;
        }
    };
    const isValid = () => isStorageValid;
    return {
        get value() {
            return state.value;
        },
        set value(v) {
            set(v);
        },
        set,
        clear,
        getSize,
        isValid,
    };
}
