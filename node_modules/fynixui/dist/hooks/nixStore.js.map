{
  "version": 3,
  "sources": ["../../hooks/nixStore.ts"],
  "sourcesContent": ["/* MIT License\r\n\r\n* Copyright (c) 2026 Resty Gonzales\r\n\r\nPermission is hereby granted, free of charge, to any person obtaining a copy\r\nof this software and associated documentation files (the \"Software\"), to deal\r\nin the Software without restriction, including without limitation the rights\r\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\ncopies of the Software, and to permit persons to whom the Software is\r\nfurnished to do so, subject to the following conditions:\r\n\r\nThe above copyright notice and this permission notice shall be included in all\r\ncopies or substantial portions of the Software.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\r\n* SOFTWARE.\r\n */\r\nimport { activeContext } from \"../context/context\";\r\n\r\n/**\r\n * Reactive store hook with subscription support and enhanced security.\r\n * Memory-safe: cleans up subscribers on component unmount.\r\n * Prevents prototype pollution and validates inputs.\r\n *\r\n * @template T\r\n * @param {string} path - Path identifier (required, must be safe)\r\n * @param {T} initial - Initial value\r\n * @returns {Object} Reactive store object with get/set/subscribe\r\n */\r\nexport function nixStore<T = any>(\r\n  path: string,\r\n  initial: T\r\n): {\r\n  value: T;\r\n  subscribe: (fn: () => void) => () => void;\r\n  path: string;\r\n  cleanup: () => void;\r\n  getSubscriberCount: () => number;\r\n  isDestroyed: () => boolean;\r\n  _isNixState: boolean;\r\n} {\r\n  // Input validation\r\n  if (!path || typeof path !== \"string\") {\r\n    throw new Error(\"[nixStore] Path must be a non-empty string\");\r\n  }\r\n\r\n  // Validate path for security (prevent prototype pollution)\r\n  const dangerousKeys = [\"__proto__\", \"constructor\", \"prototype\"];\r\n  if (dangerousKeys.some((key) => path.includes(key))) {\r\n    throw new Error(\"[nixStore] Path contains dangerous keywords\");\r\n  }\r\n\r\n  if (path.length > 200) {\r\n    throw new Error(\"[nixStore] Path too long (max 200 characters)\");\r\n  }\r\n\r\n  type StoreHook = {\r\n    value: T;\r\n    subscribe: (fn: () => void) => () => void;\r\n    path: string;\r\n    cleanup: () => void;\r\n    getSubscriberCount: () => number;\r\n    isDestroyed: () => boolean;\r\n    _isNixState: boolean;\r\n  };\r\n\r\n  const ctx = activeContext as\r\n    | (typeof activeContext & {\r\n        hookIndex: number;\r\n        hooks: Array<StoreHook | undefined>;\r\n        cleanups?: Array<() => void>;\r\n      })\r\n    | undefined;\r\n  if (!ctx) throw new Error(\"nixStore() called outside component\");\r\n\r\n  const idx: number = ctx.hookIndex++;\r\n\r\n  if (!ctx.hooks[idx]) {\r\n    let value: T = initial;\r\n    const subscribers: Set<() => void> = new Set();\r\n    let isDestroyed = false;\r\n    let maxSubscribers = 100; // Prevent memory leaks\r\n\r\n    const s: StoreHook = {\r\n      get value() {\r\n        if (isDestroyed) {\r\n          console.warn(\"[nixStore] Accessing destroyed store:\", path);\r\n          return value;\r\n        }\r\n\r\n        try {\r\n          if ((activeContext as any)?._accessedStates) {\r\n            (activeContext as any)._accessedStates.add(s);\r\n          }\r\n        } catch (err) {\r\n          console.error(\"[nixStore] Error tracking accessed state:\", err);\r\n        }\r\n        return value;\r\n      },\r\n      set value(v: T) {\r\n        if (isDestroyed) {\r\n          console.warn(\r\n            \"[nixStore] Attempting to set value on destroyed store:\",\r\n            path\r\n          );\r\n          return;\r\n        }\r\n\r\n        // Validate value for security\r\n        if (v && typeof v === \"object\") {\r\n          // Create safe object without dangerous properties\r\n          const safeValue = Object.create(null);\r\n          for (const key in v) {\r\n            if (\r\n              Object.prototype.hasOwnProperty.call(v, key) &&\r\n              !dangerousKeys.includes(key)\r\n            ) {\r\n              safeValue[key] = v[key];\r\n            }\r\n          }\r\n          value = safeValue as T;\r\n        } else {\r\n          value = v;\r\n        }\r\n\r\n        // Notify subscribers safely\r\n        const subscriberArray = Array.from(subscribers);\r\n        subscriberArray.forEach((fn) => {\r\n          try {\r\n            fn();\r\n          } catch (err) {\r\n            console.error(\"[nixStore] Subscriber error:\", err);\r\n            // Remove failing subscriber to prevent repeated errors\r\n            subscribers.delete(fn);\r\n          }\r\n        });\r\n      },\r\n      subscribe(fn: () => void) {\r\n        if (isDestroyed) {\r\n          console.warn(\r\n            \"[nixStore] Attempting to subscribe to destroyed store:\",\r\n            path\r\n          );\r\n          return () => {};\r\n        }\r\n\r\n        if (typeof fn !== \"function\") {\r\n          console.error(\"[nixStore] Subscriber must be a function\");\r\n          return () => {};\r\n        }\r\n\r\n        if (subscribers.size >= maxSubscribers) {\r\n          console.warn(\r\n            `[nixStore] Maximum subscribers (${maxSubscribers}) reached for store:`,\r\n            path\r\n          );\r\n          return () => {};\r\n        }\r\n\r\n        subscribers.add(fn);\r\n        // Return cleanup function\r\n        return () => {\r\n          subscribers.delete(fn);\r\n        };\r\n      },\r\n      cleanup() {\r\n        if (isDestroyed) return;\r\n\r\n        isDestroyed = true;\r\n        subscribers.clear();\r\n        console.debug(`[nixStore] Cleaned up store: ${path}`);\r\n      },\r\n      getSubscriberCount: () => subscribers.size,\r\n      isDestroyed: () => isDestroyed,\r\n      path,\r\n      _isNixState: true,\r\n    };\r\n\r\n    // Register cleanup on component unmount\r\n    if (!ctx.cleanups) ctx.cleanups = [];\r\n    ctx.cleanups.push(() => s.cleanup());\r\n\r\n    ctx.hooks[idx] = s;\r\n  }\r\n\r\n  return ctx.hooks[idx] as StoreHook;\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
